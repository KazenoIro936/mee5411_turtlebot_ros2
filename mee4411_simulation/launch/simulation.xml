<launch>
    <arg name="model"
         default="$(env TURTLEBOT3_MODEL)"
         description="model type [burger, waffle, waffle_pi]"/>
    <arg name="initial_pose_x"
         default="0.0"
         description="initial x position of the robot"/>
    <arg name="initial_pose_y"
         default="0.0"
         description="initial y position of the robot"/>
    <arg name="initial_pose_a"
         default="0.0"
         description="initial angle of the robot"/>
    <arg name="joint_noise_std"
         default="0.0"
         description="standard deviation of wheel noise per second"/>
    <arg name="lidar_noise_std"
         default="0.0"
         description="Standard deviation of lidar measurements in meter"/>
    <arg name="sim_namespace"
         default="ground_truth/"
         description="namespace for `real` simulated robot" />
    <arg name="map_filename"
         default="$(find-pkg-share occupancy_grid)/maps/levine-4.yaml"
         description="YAML file for the map"/>
    <arg name="map_conversions_implemented"
         default="True"
         description="Whether map conversions have been implemented"/>
    <arg name="use_nav2_planner"
         default="True"
         description="Whether to use nav2 planner"/>
    <arg name="use_sim_time"
         default="False"
         description="Whether to use simulation time"/>

    <!-- Robot file -->
    <let name="urdf"
         value="$(find-pkg-share turtlebot3_description)/urdf/turtlebot3_$(env TURTLEBOT3_MODEL).urdf"/>

    <!-- Simulated Robot -->
    <group>
        <push-ros-namespace namespace="$(var sim_namespace)"/>
        <include file="$(find-pkg-share mee4411_simulation)/launch/tb3_simulation.xml">
            <arg name="sim_namespace"   value="$(var sim_namespace)" />
            <arg name="initial_pose_x"  value="$(var initial_pose_x)" />
            <arg name="initial_pose_y"  value="$(var initial_pose_y)" />
            <arg name="initial_pose_a"  value="$(var initial_pose_a)" />
            <arg name="joint_noise_std" value="$(var joint_noise_std)" />
            <arg name="lidar_noise_std" value="$(var lidar_noise_std)" />
        </include>
    </group>

    <!-- Transformations -->
    <node name="robot_state_publisher"
          pkg="robot_state_publisher"
          exec="robot_state_publisher"
          output="screen">
        <param name="publish_frequency" value="50.0" />
        <param name='robot_description' value="$(command 'xacro $(var urdf)')"/>
        <param name="use_sim_time" value="$(var use_sim_time)"/>
    </node>

    <!-- Odometry -->
    <!-- <node name="turtlebot3_fake_node"
          pkg="turtlebot3_fake_node"
          exec="turtlebot3_fake_node"
          output="screen">
        <param from="$(find-pkg-share turtlebot3_fake_node)/param/$(env TURTLEBOT3_MODEL).yaml"/>
        <param name="use_sim_time" value="$(var use_sim_time)"/>
    </node> -->
    <node name="wheel_odometry" 
          pkg="wheel_odometry" 
          exec="wheel_odometry" 
          output="screen">
        <param name="base_frame" value="base_footprint"/>
        <param name="odom_frame" value="odom"/>
        <param name="tb3_model" value="$(env TURTLEBOT3_MODEL)"/>
     </node>

    <!-- Localization -->
    <node
      pkg="lidar_localization"
      exec="icp_node"
      name="icp_localization"
      output="screen">
      <param name="initial_pose_x" value="$(var initial_pose_x)"/>
      <param name="initial_pose_y" value="$(var initial_pose_y)"/>
      <param name="initial_pose_a" value="$(var initial_pose_a)"/>
      <param name="odom_frame" value="odom"/>
      <param name="time_travel" value="0.1"/>
      <param name="use_map_topic" value="False"/>
      <param name="use_sim_time" value="$(var use_sim_time)"/>
    </node>

    <!-- Navigation -->
    <include file="$(find-pkg-share mee4411_simulation)/launch/navigation_launch.py">
        <arg name="use_sim_time" value="$(var use_sim_time)"/>
        <arg name="map_filename" value="$(var map_filename)"/>
        <arg name="params_file" value="$(find-pkg-share turtlebot3_navigation2)/param/humble/$(env TURTLEBOT3_MODEL).yaml"/>
        <arg name="use_planner" value="$(var use_nav2_planner)"/>
    </include>

    <!-- Global planning -->
     <node
          pkg="global_planning"
          exec="prm_node"
          name="planner_service"
          output="screen"
          unless="$(var use_nav2_planner)">
          <param name="robot_frame"        value="base_footprint"/>
          <param name="show_prm"           value="True"/>
          <param name="publish_every_n"    value="20"/>
          <param name="connection_radius"  value="1.0"/>
          <param name="step_size"          value="0.01"/>
          <param name="num_points"         value="1000"/>
          <param name="use_sim_time"       value="$(var use_sim_time)"/>
     </node>
    <!-- Local controller -->

    <!-- Collision detection -->
    <include file="$(find-pkg-share mee4411_simulation)/launch/collision_detector.py">
        <arg name="map_conversions_implemented" value="$(var map_conversions_implemented)"/>
        <arg name="use_sim_time" value="$(var use_sim_time)"/>
        <arg name="sim_namespace" value="$(var sim_namespace)"/>
    </include>

    <!-- Robot visualization -->
    <node name="rviz"
          pkg="rviz2"
          exec="rviz2"
          args="-d $(find-pkg-share mee4411_simulation)/rviz/mee4411.rviz">
        <param name="use_sim_time" value="$(var use_sim_time)"/>
    </node>

</launch>
